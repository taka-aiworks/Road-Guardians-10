<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Road Guardians: Tap Strike</title>
<style>
  :root{--bg:#0e1320;--panel:#151b28;--accent:#4cc9f0;--ok:#22c55e;--warn:#f59e0b}
  html,body{margin:0;background:var(--bg);color:#eef;font-family:system-ui,-apple-system,Segoe UI,Roboto}
  #title{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
    background:radial-gradient(80% 65% at 50% 30%,#17203a 0%,#0e1322 60%,#0a0f1c 100%);z-index:99}
  .tbox{width:min(800px,94vw);text-align:center;padding:24px}
  .logo{font-size:clamp(32px,6vw,60px);font-weight:900;margin:0 0 6px;background:linear-gradient(180deg,#e2e8f0,#bcd7ff 45%,#7bc6ff 80%);-webkit-background-clip:text;color:transparent}
  .sub{opacity:.9;margin:0 0 14px}
  .btn{padding:12px 16px;border:1px solid #2a3446;border-radius:12px;background:#1a2333;color:#eef;font-weight:800}
  .ok{background:#12492b;border-color:#1b6e3c}
  #hud{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap;padding:8px;background:#11182a;position:sticky;top:0;z-index:2}
  .pill{padding:6px 10px;border-radius:999px;background:#1c2438;font-weight:700}
  #wrap{display:flex;flex-direction:column;gap:8px;align-items:center}
  canvas{background:#0f1724;border-radius:12px;touch-action:none;box-shadow:0 0 0 1px #213048 inset}
  #shop{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;width:min(720px,96vw);padding:8px}
  .card{background:#162033;border:1px solid #253447;border-radius:12px;padding:10px}
  .row{display:flex;justify-content:space-between;align-items:center}
  #toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#1b2434;border:1px solid #2b3a52;padding:8px 12px;border-radius:10px;opacity:0;transition:.25s;pointer-events:none}
  #err{display:none;position:fixed;left:8px;right:8px;bottom:8px;background:#1b2433;border:1px solid #2b3a52;padding:10px;border-radius:10px;white-space:pre-wrap;font-family:ui-monospace,monospace;max-height:40vh;overflow:auto}
  .hint{font-size:14px;opacity:.9;margin-top:8px}
</style>
</head>
<body>
<!-- タイトル -->
<div id="title">
  <div class="tbox">
    <h1 class="logo">Road Guardians: Tap Strike</h1>
    <p class="sub">3レーンをタップして撃つ！当ててコイン→その場で強化。全10ステージ。</p>
    <p class="hint">遊び方：<b>レーンをタップ</b>→ショット／<b>強化</b>で連射＆火力UP／敵が左へ到達でライフ-1</p>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:8px">
      <button id="startSound" class="btn ok">▶ サウンドONでスタート</button>
      <button id="startMute" class="btn">▶ ミュートでスタート</button>
    </div>
  </div>
</div>

<!-- 本体 -->
<div id="game" style="display:none">
  <div id="hud">
    <span class="pill">❤️ <b id="life">10</b></span>
    <span class="pill">💰 <b id="gold">0</b></span>
    <span class="pill">📍 Stage <b id="stage">1</b>/10</span>
    <span class="pill">🗡️ Wave <b id="wave">0</b>/<b id="wavemax">0</b></span>
    <button id="pause" class="btn">⏸</button>
    <button id="speed" class="btn">⏩ ×1</button>
    <button id="bgm" class="btn">♪ BGM OFF</button>
  </div>

  <div id="wrap">
    <canvas id="cv"></canvas>

    <div id="shop">
      <div class="card">
        <div class="row"><b>攻撃力</b><button id="upPow" class="btn ok">強化（💵<span id="powC">30</span>）</button></div>
        <div class="hint">1発のダメージUP</div>
      </div>
      <div class="card">
        <div class="row"><b>連射</b><button id="upRate" class="btn ok">強化（💵<span id="rateC">30</span>）</button></div>
        <div class="hint">クールダウン短縮</div>
      </div>
      <div class="card">
        <div class="row"><b>オート</b><button id="toggleAuto" class="btn">OFF</button></div>
        <div class="hint">次の敵を自動で狙撃</div>
      </div>
    </div>
  </div>
</div>

<div id="toast"></div>
<div id="err"></div>

<script>
(()=>{
// ===== エラー表示 =====
const errEl=document.getElementById('err');
window.addEventListener('error',e=>{errEl.style.display='block';errEl.textContent='JS Error: '+(e.message||e.error);});

// ===== DOM =====
const $=s=>document.querySelector(s);
const cv=$("#cv"), ctx=cv.getContext('2d');
const lifeEl=$("#life"), goldEl=$("#gold"), stageEl=$("#stage"), waveEl=$("#wave"), wmaxEl=$("#wavemax");
const startSound=$("#startSound"), startMute=$("#startMute"), title=$("#title"), game=$("#game");
const pauseBtn=$("#pause"), speedBtn=$("#speed"), bgmBtn=$("#bgm");
const upPow=$("#upPow"), upRate=$("#upRate"), powC=$("#powC"), rateC=$("#rateC"), autoBtn=$("#toggleAuto");
const toastEl=$("#toast");

// ===== サイズ（ピクセルパーフェクト） =====
const DPR=Math.max(1,Math.min(2,window.devicePixelRatio||1));
const COLS=12, ROWS=8; // プレイ領域（中央に3レーンを引く）
let TILE=40;
function fit(){
  const maxCssW=Math.min(960,window.innerWidth*0.96);
  const maxCssH=Math.min(560,window.innerHeight*0.5);
  const maxPxW=Math.floor(maxCssW*DPR), maxPxH=Math.floor(maxCssH*DPR);
  TILE=Math.max(8, Math.min(Math.floor(maxPxW/COLS), Math.floor(maxPxH/ROWS)));
  const w=TILE*COLS, h=TILE*ROWS;
  cv.width=w; cv.height=h; cv.style.width=(w/DPR)+'px'; cv.style.height=(h/DPR)+'px';
}
window.addEventListener('resize',fit);

// ===== サウンド =====
const AudioSys={ctx:null,master:null,sfx:null,bgm:null,on:false,bgmOn:false,bpm:96,timer:null,step:0,theme:0};
function ensureCtx(){if(AudioSys.ctx)return;const AC=window.AudioContext||window.webkitAudioContext;const ctx=new AC();
  const master=ctx.createGain();master.gain.value=0.9;master.connect(ctx.destination);
  const sfx=ctx.createGain();sfx.gain.value=0.9;sfx.connect(master);
  const bgm=ctx.createGain();bgm.gain.value=0.24;bgm.connect(master);
  AudioSys.ctx=ctx;AudioSys.master=master;AudioSys.sfx=sfx;AudioSys.bgm=bgm;}
function resumeCtx(){if(AudioSys.ctx&&AudioSys.ctx.state!=='running')AudioSys.ctx.resume();}
function setAudio(v){ensureCtx();resumeCtx();AudioSys.on=v;AudioSys.master.gain.value=v?0.9:0;bgmBtn.textContent=AudioSys.bgmOn?'♪ BGM ON':'♪ BGM OFF';}
function setBGM(v){ensureCtx();resumeCtx();AudioSys.bgmOn=v;if(v)startBGM();else stopBGM();bgmBtn.textContent=v?'♪ BGM ON':'♪ BGM OFF';}
function osc(o){if(!AudioSys.on||!AudioSys.ctx)return;const ctx=AudioSys.ctx,osc=ctx.createOscillator(),g=ctx.createGain();
  osc.type=o.type||'sine';osc.frequency.value=o.f||440;osc.connect(g);g.connect(o.out==='bgm'?AudioSys.bgm:AudioSys.sfx);
  const t=ctx.currentTime;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(o.g||0.25,t+0.01);g.gain.exponentialRampToValueAtTime(0.0001,t+(o.d||0.12));
  if(o.glide)osc.frequency.exponentialRampToValueAtTime(Math.max(80,(o.f||440)*o.glide),t+(o.d||0.12)*0.9);osc.start(t);osc.stop(t+(o.d||0.12)+0.02);}
function noise(o){if(!AudioSys.on||!AudioSys.ctx)return;const ctx=AudioSys.ctx,buf=ctx.createBuffer(1,ctx.sampleRate*(o.d||0.18),ctx.sampleRate),d=buf.getChannelData(0);
  for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;const src=ctx.createBufferSource();src.buffer=buf; const f=ctx.createBiquadFilter();f.type='lowpass';f.frequency.value=o.lp||1200;
  const g=ctx.createGain();g.gain.value=o.g||0.28;src.connect(f);f.connect(g);g.connect(o.out==='bgm'?AudioSys.bgm:AudioSys.sfx);
  const t=ctx.currentTime;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(g.gain.value,t+0.02);g.gain.exponentialRampToValueAtTime(0.0001,t+(o.d||0.18));
  src.start(t);src.stop(t+(o.d||0.18)+0.02);}
const SFX={tap:()=>osc({f:1000,d:0.06,type:'square',g:0.16}),
           hit:()=>osc({f:420,d:0.06,type:'square',g:0.13}),
           kill:()=>{osc({f:800,d:0.08,type:'triangle',g:0.2});osc({f:1200,d:0.07,type:'triangle',g:0.16});},
           dmg:()=>osc({f:280,d:0.12,type:'sine',g:0.22,glide:0.6}),
           coin:()=>{osc({f:1200,d:0.08,g:0.22});osc({f:1600,d:0.08,g:0.18});},
           start:()=>{osc({f:600,d:0.12,type:'triangle',g:0.2});osc({f:900,d:0.12,type:'triangle',g:0.18});}};
function startBGM(){stopBGM();if(!AudioSys.on)return;const tick=(60000/AudioSys.bpm)/4;AudioSys.step=0;
  AudioSys.timer=setInterval(()=>{if(!AudioSys.bgmOn||!AudioSys.on)return;const s=AudioSys.step%16,bar=Math.floor(AudioSys.step/16)%8;
    const chords=[[261.63,329.63,392],[220,261.63,329.63],[174.61,220,261.63],[196,246.94,293.66],
                  [293.66,349.23,440],[233.08,277.18,349.23],[261.63,329.63,392],[329.63,392,493.88]];
    const ch=chords[bar], dens=1+AudioSys.theme;
    if(s%8===0) noise({d:0.08,lp:400,g:0.14+0.03*dens,out:'bgm'});
    if(s%2===0) noise({d:0.04,lp:6000,g:0.06+0.02*dens,out:'bgm'});
    if(s%4===0) {osc({f:ch[0],d:0.12,type:'triangle',g:0.08+0.01*dens,out:'bgm'});osc({f:ch[1],d:0.12,type:'triangle',g:0.07+0.01*dens,out:'bgm'});osc({f:ch[2],d:0.12,type:'triangle',g:0.07+0.01*dens,out:'bgm'});}
    if(s===0||s===8) osc({f:ch[0]/2,d:0.16,type:'sawtooth',g:0.10+0.02*dens,glide:0.9,out:'bgm'});
    AudioSys.step++;},tick);}
function stopBGM(){if(AudioSys.timer){clearInterval(AudioSys.timer);AudioSys.timer=null;}}

// ===== ゲームデータ =====
const LANES=[2,4,6]; // y(行)
const ENEMY={grunt:{hp:40, spd:0.9, gold:6, color:'#67e8f9'},
             fast :{hp:28, spd:1.5, gold:7, color:'#f59e0b'},
             tank :{hp:100,spd:0.6, gold:12,color:'#86efac'},
             bat  :{hp:30, spd:1.2, gold:8, color:'#c084fc'}};
const Waves=[
  ["grunt,8"],["grunt,10"],["fast,8"],["grunt,10|fast,6"],["tank,5"],["bat,10"],["grunt,8|tank,6"],["fast,10|bat,8"],["tank,8"],["tank,1|fast,12|bat,12"]
];
const StageHP=[10,10,10,9,9,8,8,7,7,6];
const StageGold=[40,60,80,90,110,130,150,170,190,220];

const G={life:10,gold:0,stage:0,wave:0,wavemax:0,paused:false,speed:1,auto:false,
         pow:10, rate:0.35, powCost:30, rateCost:30, cd:0,
         enemies:[], shots:[], t:0};

// ===== 便利 =====
function toast(s){clearTimeout(toast._t);toastEl.textContent=s;toastEl.style.opacity=1;toast._t=setTimeout(()=>toastEl.style.opacity=0,1200);}
function rand(a,b){return a+Math.random()*(b-a);}
function parsePack(str){return str.split("|").map(p=>{const [t,n]=p.split(",");return {type:t.trim(), n:parseInt(n||"1",10)};});}

// ===== スタート/進行 =====
function startStage(i){
  G.stage=i; G.wave=0; G.wavemax=Waves.length; G.enemies=[]; G.shots=[];
  G.life=StageHP[i]; G.gold=StageGold[i]; G.pow=10; G.rate=0.35; G.powCost=30; G.rateCost=30; G.cd=0;
  updateHUD(); fit(); draw();
  toast(`Stage ${i+1}`); AudioSys.theme = (i<3?0: i<7?1:2); AudioSys.bpm = 90 + i*2;
}
function startWave(){
  if(G.wave>=G.wavemax)return;
  const pack=parsePack(Waves[G.wave]); // キュー作成
  const queue=[];
  for(const p of pack){for(let i=0;i<p.n;i++) queue.push(p.type);}
  // 一定間隔でレーンに出す
  let k=0;
  const spawner=setInterval(()=>{
    if(G.paused) return;
    if(k>=queue.length){clearInterval(spawner);return;}
    const type=queue[k++]; spawn(type);
  }, Math.max(280 - G.stage*10, 160));
}
function spawn(type){
  const spec=ENEMY[type]||ENEMY.grunt;
  const lane=LANES[Math.floor(Math.random()*LANES.length)];
  G.enemies.push({type,x:COLS-1+0.2,y:lane+0.5,hp:spec.hp,hpMax:spec.hp,spd:spec.spd,gold:spec.gold,color:spec.color,alive:true});
}

// ===== 入力：タップでそのレーンにショット =====
function cellFromEvent(ev){
  const r=cv.getBoundingClientRect();
  const x=((ev.touches?ev.touches[0].clientX:ev.clientX)-r.left)*(cv.width/r.width);
  const y=((ev.touches?ev.touches[0].clientY:ev.clientY)-r.top)*(cv.height/r.height);
  return {cx:Math.floor(x/TILE), cy:Math.floor(y/TILE)};
}
function fireToLane(yRow){
  if(G.cd>0) return; // 連射制限
  G.cd = G.rate;
  G.shots.push({x:1.0,y:yRow+0.5,spd:8,dmg:G.pow});
  SFX.tap();
}
cv.addEventListener('pointerdown',e=>{e.preventDefault();const c=cellFromEvent(e);
  // 一番近いレーンにスナップ
  let lane=LANES[0], best=1e9;
  for(const L of LANES){const dy=Math.abs((L+0.5)- (c.cy+0.5)); if(dy<best){best=dy; lane=L;}}
  fireToLane(lane);
});
cv.addEventListener('touchstart',e=>{const c=cellFromEvent(e); let lane=LANES[0],best=1e9;
  for(const L of LANES){const dy=Math.abs((L+0.5)- (c.cy+0.5)); if(dy<best){best=dy; lane=L;}}
  fireToLane(lane);
},{passive:true});

// ===== 強化 =====
function tryBuy(cost){ if(G.gold<cost){toast('お金が足りない');return false;} G.gold-=cost; updateHUD(); return true; }
upPow.addEventListener('click',()=>{ if(tryBuy(G.powCost)){ G.pow=Math.round(G.pow*1.25); G.powCost=Math.round(G.powCost*1.6); powC.textContent=G.powCost; toast('攻撃力アップ'); }});
upRate.addEventListener('click',()=>{ if(tryBuy(G.rateCost)){ G.rate=Math.max(0.12, G.rate*0.82); G.rateCost=Math.round(G.rateCost*1.7); rateC.textContent=G.rateCost; toast('連射アップ'); }});
autoBtn.addEventListener('click',()=>{ G.auto=!G.auto; autoBtn.textContent=G.auto?'ON':'OFF'; });

// ===== HUD =====
function updateHUD(){
  lifeEl.textContent=G.life; goldEl.textContent=G.gold;
  stageEl.textContent=G.stage+1; waveEl.textContent=G.wave; wmaxEl.textContent=G.wavemax;
}

// ===== ループ =====
let last=0; function loop(ts){
  requestAnimationFrame(loop);
  const dt=Math.min(40, ts-last)||16; last=ts;
  if(G.paused){draw();return;}
  const mul=G.speed;

  // クールダウン
  G.cd=Math.max(0, G.cd-dt*0.001*mul);

  // オート狙撃
  if(G.auto && G.cd<=0){
    // もっとも左に近い敵のレーンを撃つ
    let target=null, best=9999;
    for(const e of G.enemies){ if(!e.alive) continue; if(e.x<best){best=e.x; target=e;}}
    if(target){ fireToLane(Math.round(target.y-0.5)); }
  }

  // 敵移動
  for(const e of G.enemies){
    if(!e.alive) continue;
    e.x -= e.spd * dt*0.0025 * mul;
    if(e.x<=0.5){ // 到達
      e.alive=false; G.life--; SFX.dmg(); if(G.life<=0){ gameOver(); return; }
      updateHUD();
    }
  }

  // 弾
  for(const s of G.shots){ s.x += s.spd * dt*0.01 * mul; }
  // ヒット
  for(const s of G.shots){
    for(const e of G.enemies){
      if(!e.alive) continue;
      if(Math.abs(s.y-e.y)<0.6 && Math.abs(s.x-e.x)<0.6){
        e.hp -= s.dmg; SFX.hit(); s.x=99;
        if(e.hp<=0){ e.alive=false; G.gold+=e.gold; SFX.kill(); SFX.coin(); updateHUD(); }
      }
    }
  }
  // 片付け
  G.shots = G.shots.filter(s=>s.x<COLS+1);
  // ウェーブ終了判定
  if(G.enemies.every(e=>!e.alive) && G.waveStarted){
    G.wave++; G.waveStarted=false;
    if(G.wave>=G.wavemax){ toast('ステージクリア！ ▶ 次へ'); }
    else setTimeout(()=>{G.waveStarted=true; startWave(); updateHUD();}, 500);
  }

  draw();
}

function gameOver(){ G.paused=true; toast('ゲームオーバー'); }

function draw(){
  ctx.clearRect(0,0,cv.width,cv.height);

  // 背景タイル
  for(let y=0;y<ROWS;y++){
    for(let x=0;x<COLS;x++){
      ctx.fillStyle=(y%2^x%2)?'#101b2b':'#0f1928';
      ctx.fillRect(x*TILE,y*TILE,TILE,TILE);
    }
  }

  // レーン（3本）
  ctx.fillStyle='rgba(76,201,240,.10)';
  for(const L of LANES) ctx.fillRect(0,(L-0.2)*TILE, cv.width, 1.4*TILE);

  // 砲台（左側）
  ctx.fillStyle='#7bc6ff';
  for(const L of LANES){
    ctx.beginPath(); ctx.arc(1.0*TILE, (L+0.5)*TILE, TILE*0.35, 0, Math.PI*2); ctx.fill();
  }

  // 敵
  for(const e of G.enemies){
    if(!e.alive) continue;
    const x=e.x*TILE, y=e.y*TILE;
    ctx.fillStyle='rgba(0,0,0,.28)'; ctx.beginPath(); ctx.ellipse(x,y+7,12,6,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=e.color; ctx.beginPath(); ctx.arc(x,y,14,0,Math.PI*2); ctx.fill();
    // HPバー
    const w=28; ctx.fillStyle='#111'; ctx.fillRect(x-w/2,y-22,w,5);
    ctx.fillStyle='#22c55e'; ctx.fillRect(x-w/2,y-22, Math.max(0,w*(e.hp/e.hpMax)), 5);
  }

  // 弾
  ctx.fillStyle='#fde047';
  for(const s of G.shots){ ctx.beginPath(); ctx.arc(s.x*TILE,s.y*TILE,6,0,Math.PI*2); ctx.fill(); }

  // UIヒント（CD）
  if(G.cd>0){
    ctx.fillStyle='rgba(255,255,255,.2)';
    ctx.fillRect(0, (LANES[0]-0.2)*TILE, TILE*0.6*(G.cd/0.6), 1.4*TILE);
  }
}

// ===== ボタン =====
pauseBtn.addEventListener('click',()=>{G.paused=!G.paused; pauseBtn.textContent=G.paused?'▶':'⏸';});
let speed=1; speedBtn.addEventListener('click',()=>{speed=(speed===1?2:1);G.speed=speed; speedBtn.textContent='⏩ ×'+speed;});
bgmBtn.addEventListener('click',()=>{ if(!AudioSys.on) setAudio(true); setBGM(!AudioSys.bgmOn); });

function nextStage(){
  if(G.wave<G.wavemax) return;
  if(G.stage<9){ startStage(G.stage+1); } else { toast('全クリア！'); }
}

// ===== スタート =====
function startGame(withSound){
  title.style.display='none'; game.style.display='block';
  fit(); draw();
  if(withSound){setAudio(true); setBGM(true);} else {setAudio(false); setBGM(false);}
  startStage(0);
  requestAnimationFrame(loop);
  // 最初のWave
  G.wave=0; G.waveStarted=true; startWave(); updateHUD(); SFX.start();
}
startSound.addEventListener('click',()=>{ensureCtx(); resumeCtx(); startGame(true);});
startMute.addEventListener('click',()=>startGame(false));

// 画面タップで次ステージ（クリア時のみ）
cv.addEventListener('dblclick',()=>nextStage());

// 初期レンダリング
window.addEventListener('load',()=>{fit(); draw();});
})();
</script>
</body>
</html>
