<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Road Guardians 10</title>
<style>
  :root { --bg:#0f1320; --panel:#151b28; --accent:#4cc9f0; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; }
  html,body{margin:0;background:var(--bg);color:#eef;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  #title{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:radial-gradient(84% 70% at 50% 30%, #17203a 0%, #0e1322 60%, #0a0f1c 100%); z-index:999;}
  .tbox{width:min(820px,94vw);text-align:center;padding:28px 18px;}
  .logo{font-size:clamp(32px,5.6vw,64px);font-weight:900;margin:0 0 10px;background:linear-gradient(180deg,#e2e8f0 0%,#bcd7ff 40%,#7bc6ff 80%);-webkit-background-clip:text;background-clip:text;color:transparent;}
  .subtitle{opacity:.9;margin:0 0 22px}
  .startRow{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:14px}
  .btn{padding:12px 16px;border:1px solid #2a3446;border-radius:12px;background:#1a2333;color:#eef;font-weight:800;touch-action:manipulation}
  .btn.ok{border-color:#1b6e3c;background:#12492b}
  .btn.alt{border-color:#3a455a;background:#101725}
  #game{display:none}
  #hud{display:flex;gap:8px;align-items:center;justify-content:center;padding:8px;background:var(--panel);flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:999px;background:#1e2538;font-weight:600}
  #wrap{display:flex;flex-direction:column;gap:8px;align-items:center}
  canvas{background:#0f1724;border:1px solid #203046;border-radius:10px;touch-action:none}
  #shop{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:8px;width:min(720px,96vw)}
  .card{background:#172033;border:1px solid #24344b;border-radius:12px;padding:10px}
  .card h4{margin:.2rem 0 .4rem 0}
  .row{display:flex;gap:8px;align-items:center;justify-content:space-between}
  #bottom{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;padding:8px;width:min(720px,96vw)}
  #toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#1b2433;border:1px solid #2b3a52;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transition:.3s;pointer-events:none;z-index:3}
  .sel{outline:2px solid var(--accent)}
  #err{display:none;position:fixed;left:8px;right:8px;bottom:8px;background:#1b2433;color:#fff;border:1px solid #2b3a52;padding:10px;border-radius:10px;z-index:99999;font-family:monospace;white-space:pre-wrap;max-height:45vh;overflow:auto}
</style>
</head>
<body>
<div id="title">
  <div class="tbox">
    <h1 class="logo">Road Guardians 10</h1>
    <p class="subtitle">スマホ向けタワーディフェンス 全10ステージ</p>
    <div class="startRow">
      <button id="btnStartSound" class="btn ok">▶ サウンド ON で開始</button>
      <button id="btnStartMute" class="btn alt">▶ ミュートで開始</button>
    </div>
  </div>
</div>

<div id="game">
  <div id="hud">
    <span class="pill">❤️ <b id="life">20</b></span>
    <span class="pill">💰 <b id="gold">100</b></span>
    <span class="pill">🗡️ Wave <b id="wave">0</b>/<b id="waveMax">0</b></span>
    <span class="pill">📍 Stage <b id="stage">1</b>/10</span>
    <button id="btnStart" class="btn ok">▶ 次ウェーブ</button>
    <button id="btnSpeed" class="btn">⏩ ×1</button>
    <button id="btnPause" class="btn">⏸</button>
    <button id="btnAudio" class="btn">🔇 音 OFF</button>
    <button id="btnBGM" class="btn">♪ BGM OFF</button>
  </div>

  <div id="wrap">
    <canvas id="cv" width="960" height="576"></canvas>
    <div id="shop">
      <div class="card" data-tower="archer"><h4>アーチャー</h4><div>単体高DPS / 飛行可</div><div class="row"><span>💵 60</span><button class="btn ok placeBtn" data-t="archer">設置</button></div></div>
      <div class="card" data-tower="cannon"><h4>キャノン</h4><div>範囲攻撃 / 飛行不可</div><div class="row"><span>💵 80</span><button class="btn ok placeBtn" data-t="cannon">設置</button></div></div>
      <div class="card" data-tower="ice"><h4>アイス</h4><div>鈍足付与 / 補助</div><div class="row"><span>💵 70</span><button class="btn ok placeBtn" data-t="ice">設置</button></div></div>
    </div>
    <div id="bottom">
      <button id="btnUpgrade" class="btn warn">⬆ 強化</button>
      <button id="btnSell" class="btn bad">🗑 売却</button>
      <button id="btnNextStage" class="btn ok">🏁 次ステージ</button>
    </div>
  </div>
</div>

<div id="toast"></div>
<div id="err"></div>

<script>
(function(){
  window.addEventListener('error', e=>{
    const box=document.getElementById('err'); box.style.display='block';
    box.textContent='JS Error: '+(e.message||e.error);
  });

  // --- 状態 ---
  var cv=document.getElementById("cv"), ctx=cv.getContext("2d");
  var COLS=24, ROWS=15, TILE=40;
  var G={stageIdx:0,grid:null,way:null,life:20,gold:100,waveIdx:0,waveMax:0,running:false,paused:false,speed:1,towers:[],bullets:[],enemies:[],sel:null,building:null};
  var hoverCell={cx:-1,cy:-1};

  function fit(){ var w=Math.min(960,window.innerWidth*0.96); var h=w*0.6; cv.style.width=w+"px"; cv.style.height=h+"px"; }

  function toast(s){ var t=document.getElementById('toast'); t.textContent=s; t.style.opacity=1; setTimeout(()=>t.style.opacity=0,1400); }

  // --- Wave parse 修正版 ---
  function normWave(w){ if(typeof w==="string") return w; if(w&&w.length) return w.join("|"); return ""; }
  function parsePack(p){ var s=normWave(p); var parts=s.split("|"), out=[]; for(var i=0;i<parts.length;i++){var pp=(parts[i]||"").split(","); out.push({type:(pp[0]||"slime").trim(), n:parseInt(pp[1]||"1",10)});} return out;}

  function startWave(){
    if(G.running) return; var s=Stages[G.stageIdx]; if(G.waveIdx>=s.waves.length) return;
    G.running=true; spawnQueue=[]; var packs=parsePack(s.waves[G.waveIdx]);
    for(var i=0;i<packs.length;i++){ for(var j=0;j<packs[i].n;j++) spawnQueue.push(packs[i].type); }
    toast("Wave開始");
  }

  // --- Stages（簡略化: 必要なら全10面同様に書き足してOK） ---
  var Stages=[{name:"草原の道",life:20,gold:120,pathPts:[[1,7],[20,7]],waves:["slime,10","wolf,5","orc,3","bat,5","boss,1"]}];

  function startStage(i){ var s=Stages[i]; G.stageIdx=i; G.waveIdx=0; G.waveMax=s.waves.length; G.life=s.life; G.gold=s.gold; toast("Stage "+(i+1)); }

  // --- Input ---
  cv.addEventListener("pointerdown",e=>{var r=cv.getBoundingClientRect();var cx=Math.floor((e.clientX-r.left)/(cv.clientWidth/COLS));var cy=Math.floor((e.clientY-r.top)/(cv.clientHeight/ROWS));toast("("+cx+","+cy+")");});

  // --- Title screen ---
  function bind(id,fn){ document.getElementById(id).addEventListener("click",fn);}
  bind("btnStartSound",()=>{ document.getElementById("title").style.display="none"; document.getElementById("game").style.display="block"; startStage(0); });
  bind("btnStartMute",()=>{ document.getElementById("title").style.display="none"; document.getElementById("game").style.display="block"; startStage(0); });

})();
</script>
</body>
</html>
